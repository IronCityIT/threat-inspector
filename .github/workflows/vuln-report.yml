name: Threat Inspector - Vulnerability Report

# ============================================================
# VULNERABILITY REPORT - Parse scan files and generate reports
# Processes Qualys, ZAP, Nmap uploads and generates HTML report
# Triggered via CLI only - no manual runs without parameters
# ============================================================

on:
  workflow_dispatch:
    inputs:
      scan_id:
        description: 'Unique scan identifier from CLI'
        required: true
      client_id:
        description: 'Client identifier for reporting'
        required: false
        default: 'internal'

permissions:
  contents: read

concurrency:
  group: vuln-report-${{ github.event.inputs.client_id }}
  cancel-in-progress: false

jobs:
  generate_report:
    name: Parse & Generate Vulnerability Report
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate inputs
        run: |
          if [ -z "${{ github.event.inputs.scan_id }}" ]; then
            echo "‚ùå ERROR: scan_id is required"
            exit 1
          fi
          echo "‚úÖ Inputs validated"
          echo "üîñ Scan ID: ${{ github.event.inputs.scan_id }}"
          echo "üë§ Client: ${{ github.event.inputs.client_id }}"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          pip install pandas openpyxl lxml pyyaml jinja2

      - name: Load Client Config
        id: config
        run: |
          if [ -f "configs/client.yaml" ]; then
            echo "‚úÖ Found client config"
            cat configs/client.yaml
            
            # Extract client name
            CLIENT_NAME=$(grep "name:" configs/client.yaml | head -1 | sed 's/.*name: *"\?\([^"]*\)"\?/\1/')
            echo "client_name=$CLIENT_NAME" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è No client config found, using defaults"
            echo "client_name=${{ github.event.inputs.client_id }}" >> $GITHUB_OUTPUT
          fi

      - name: Parse Scan Files
        id: parse
        run: |
          mkdir -p results
          SCAN_ID="${{ github.event.inputs.scan_id }}"
          
          python3 << 'PYEOF'
          import os
          import json
          import yaml
          import pandas as pd
          import xml.etree.ElementTree as ET
          from pathlib import Path
          from collections import defaultdict
          
          scan_id = os.environ.get('SCAN_ID', 'unknown')
          
          # Load client config
          config = {}
          if Path('configs/client.yaml').exists():
              with open('configs/client.yaml') as f:
                  config = yaml.safe_load(f) or {}
          
          client_name = config.get('client', {}).get('name', 'Client')
          domains = config.get('domains', [])
          scan_files = config.get('scan_files', {})
          
          # Build domain mapping
          domain_map = {}
          for d in domains:
              name = d.get('name', '')
              for ip in d.get('ips', []):
                  domain_map[ip] = name
              domain_map[name] = name
          
          def match_domain(asset_name, asset_ip):
              if asset_name in domain_map:
                  return domain_map[asset_name]
              if asset_ip in domain_map:
                  return domain_map[asset_ip]
              return asset_name or asset_ip or 'Unknown'
          
          vulnerabilities = []
          
          # Parse Qualys XLSX/CSV
          qualys_file = scan_files.get('qualys')
          if qualys_file and Path(qualys_file).exists():
              print(f"üìÑ Parsing Qualys: {qualys_file}")
              try:
                  if qualys_file.endswith('.csv'):
                      df = pd.read_csv(qualys_file)
                  else:
                      df = pd.read_excel(qualys_file, engine='openpyxl')
                  
                  for _, row in df.iterrows():
                      vuln = {
                          'source': 'Qualys',
                          'title': str(row.get('Vulnerability Title', row.get('Title', 'Unknown'))),
                          'severity': str(row.get('Severity', row.get('Risk', 'Info'))).lower(),
                          'asset': match_domain(
                              str(row.get('Asset Name', '')),
                              str(row.get('Asset IPV4', row.get('IP', '')))
                          ),
                          'cve': str(row.get('CVE ID', row.get('CVE', ''))),
                          'description': str(row.get('Description', ''))[:500],
                          'solution': str(row.get('Solution', ''))[:500]
                      }
                      if vuln['title'] and vuln['title'] != 'nan':
                          vulnerabilities.append(vuln)
                  print(f"   Found {len([v for v in vulnerabilities if v['source']=='Qualys'])} Qualys findings")
              except Exception as e:
                  print(f"   ‚ö†Ô∏è Error parsing Qualys: {e}")
          
          # Parse ZAP XML
          zap_file = scan_files.get('zap')
          if zap_file and Path(zap_file).exists():
              print(f"üìÑ Parsing ZAP: {zap_file}")
              try:
                  tree = ET.parse(zap_file)
                  root = tree.getroot()
                  
                  risk_map = {'0': 'info', '1': 'low', '2': 'medium', '3': 'high'}
                  
                  for alert in root.findall('.//alertitem'):
                      title = alert.find('alert')
                      risk = alert.find('riskcode')
                      desc = alert.find('desc')
                      sol = alert.find('solution')
                      uri = alert.find('uri')
                      
                      vuln = {
                          'source': 'ZAP',
                          'title': title.text if title is not None else 'Unknown',
                          'severity': risk_map.get(risk.text if risk is not None else '0', 'info'),
                          'asset': uri.text.split('/')[2] if uri is not None and uri.text else 'Unknown',
                          'cve': '',
                          'description': (desc.text or '')[:500] if desc is not None else '',
                          'solution': (sol.text or '')[:500] if sol is not None else ''
                      }
                      vulnerabilities.append(vuln)
                  print(f"   Found {len([v for v in vulnerabilities if v['source']=='ZAP'])} ZAP findings")
              except Exception as e:
                  print(f"   ‚ö†Ô∏è Error parsing ZAP: {e}")
          
          # Parse Nmap TXT
          nmap_file = scan_files.get('nmap')
          if nmap_file and Path(nmap_file).exists():
              print(f"üìÑ Parsing Nmap: {nmap_file}")
              try:
                  with open(nmap_file) as f:
                      content = f.read()
                  
                  # Look for VULNERABLE markers
                  import re
                  for match in re.finditer(r'(\S+)\s+.*VULNERABLE', content, re.IGNORECASE):
                      vuln = {
                          'source': 'Nmap',
                          'title': f'Vulnerable service detected: {match.group(1)}',
                          'severity': 'high',
                          'asset': 'Nmap scan target',
                          'cve': '',
                          'description': match.group(0)[:500],
                          'solution': 'Review and patch vulnerable service'
                      }
                      vulnerabilities.append(vuln)
                  print(f"   Found {len([v for v in vulnerabilities if v['source']=='Nmap'])} Nmap findings")
              except Exception as e:
                  print(f"   ‚ö†Ô∏è Error parsing Nmap: {e}")
          
          # Count by severity
          severity_counts = defaultdict(int)
          for v in vulnerabilities:
              sev = v['severity'].lower()
              if 'crit' in sev:
                  severity_counts['critical'] += 1
              elif 'high' in sev:
                  severity_counts['high'] += 1
              elif 'med' in sev:
                  severity_counts['medium'] += 1
              elif 'low' in sev:
                  severity_counts['low'] += 1
              else:
                  severity_counts['info'] += 1
          
          # Save results
          output = {
              'client_name': client_name,
              'scan_id': scan_id,
              'total': len(vulnerabilities),
              'critical': severity_counts['critical'],
              'high': severity_counts['high'],
              'medium': severity_counts['medium'],
              'low': severity_counts['low'],
              'info': severity_counts['info'],
              'vulnerabilities': vulnerabilities
          }
          
          with open(f'results/vulnerabilities-{scan_id}.json', 'w') as f:
              json.dump(output, f, indent=2)
          
          print(f"\nüìä Total: {len(vulnerabilities)} vulnerabilities")
          print(f"   Critical: {severity_counts['critical']}")
          print(f"   High: {severity_counts['high']}")
          print(f"   Medium: {severity_counts['medium']}")
          print(f"   Low: {severity_counts['low']}")
          print(f"   Info: {severity_counts['info']}")
          
          # Write counts to file for GitHub output
          with open('results/counts.txt', 'w') as f:
              f.write(f"total={len(vulnerabilities)}\n")
              f.write(f"critical={severity_counts['critical']}\n")
              f.write(f"high={severity_counts['high']}\n")
              f.write(f"medium={severity_counts['medium']}\n")
              f.write(f"low={severity_counts['low']}\n")
              f.write(f"info={severity_counts['info']}\n")
          PYEOF
          
          # Read counts into GitHub outputs
          if [ -f results/counts.txt ]; then
            while IFS= read -r line; do
              echo "$line" >> $GITHUB_OUTPUT
            done < results/counts.txt
          fi

      - name: Generate HTML Report
        run: |
          SCAN_ID="${{ github.event.inputs.scan_id }}"
          CLIENT_NAME="${{ steps.config.outputs.client_name }}"
          
          python3 << 'PYEOF'
          import json
          import os
          from datetime import datetime
          
          scan_id = os.environ.get('SCAN_ID', 'unknown')
          client_name = os.environ.get('CLIENT_NAME', 'Client')
          
          # Load vulnerabilities
          with open(f'results/vulnerabilities-{scan_id}.json') as f:
              data = json.load(f)
          
          # Sort by severity
          severity_order = {'critical': 0, 'high': 1, 'medium': 2, 'low': 3, 'info': 4}
          vulns = sorted(data['vulnerabilities'], key=lambda v: severity_order.get(v['severity'], 5))
          
          html = f'''<!DOCTYPE html>
          <html>
          <head>
              <title>Threat Inspector - Vulnerability Report</title>
              <style>
                  body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; background: #f5f5f5; }}
                  .header {{ background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%); color: white; padding: 40px; }}
                  .header h1 {{ margin: 0 0 10px 0; }}
                  .container {{ max-width: 1200px; margin: 0 auto; padding: 20px; }}
                  .summary {{ display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin: 20px 0; }}
                  .card {{ background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }}
                  .card .count {{ font-size: 2.5em; font-weight: bold; }}
                  .card.critical .count {{ color: #dc2626; }}
                  .card.high .count {{ color: #ea580c; }}
                  .card.medium .count {{ color: #ca8a04; }}
                  .card.low .count {{ color: #2563eb; }}
                  .card.info .count {{ color: #6b7280; }}
                  .findings {{ background: white; border-radius: 8px; padding: 20px; margin-top: 20px; }}
                  table {{ width: 100%; border-collapse: collapse; }}
                  th, td {{ padding: 12px; text-align: left; border-bottom: 1px solid #eee; }}
                  th {{ background: #f8f8f8; font-weight: 600; }}
                  .severity {{ padding: 4px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 600; }}
                  .severity.critical {{ background: #fef2f2; color: #dc2626; }}
                  .severity.high {{ background: #fff7ed; color: #ea580c; }}
                  .severity.medium {{ background: #fefce8; color: #ca8a04; }}
                  .severity.low {{ background: #eff6ff; color: #2563eb; }}
                  .severity.info {{ background: #f9fafb; color: #6b7280; }}
              </style>
          </head>
          <body>
              <div class="header">
                  <div class="container">
                      <h1>üõ°Ô∏è Threat Inspector - Vulnerability Report</h1>
                      <p><strong>Client:</strong> {client_name} | <strong>Scan ID:</strong> {scan_id} | <strong>Generated:</strong> {datetime.now().strftime("%Y-%m-%d %H:%M UTC")}</p>
                  </div>
              </div>
              <div class="container">
                  <div class="summary">
                      <div class="card critical"><div class="count">{data['critical']}</div><div>Critical</div></div>
                      <div class="card high"><div class="count">{data['high']}</div><div>High</div></div>
                      <div class="card medium"><div class="count">{data['medium']}</div><div>Medium</div></div>
                      <div class="card low"><div class="count">{data['low']}</div><div>Low</div></div>
                      <div class="card info"><div class="count">{data['info']}</div><div>Info</div></div>
                  </div>
                  <div class="findings">
                      <h2>Findings ({data['total']} total)</h2>
                      <table>
                          <tr><th>Severity</th><th>Title</th><th>Asset</th><th>Source</th><th>CVE</th></tr>
          '''
          
          for v in vulns[:100]:  # Limit to 100 in HTML
              sev_class = v['severity'].lower()
              if 'crit' in sev_class: sev_class = 'critical'
              elif 'high' in sev_class: sev_class = 'high'
              elif 'med' in sev_class: sev_class = 'medium'
              elif 'low' in sev_class: sev_class = 'low'
              else: sev_class = 'info'
              
              html += f'''
                          <tr>
                              <td><span class="severity {sev_class}">{v['severity'].upper()}</span></td>
                              <td>{v['title'][:80]}{'...' if len(v['title']) > 80 else ''}</td>
                              <td>{v['asset']}</td>
                              <td>{v['source']}</td>
                              <td>{v['cve'] or '-'}</td>
                          </tr>'''
          
          html += '''
                      </table>
                  </div>
                  <p style="text-align: center; color: #666; margin-top: 40px;">
                      Generated by Iron City IT Advisors - Threat Inspector
                  </p>
              </div>
          </body>
          </html>'''
          
          with open(f'results/report-{scan_id}.html', 'w') as f:
              f.write(html)
          
          print(f"‚úÖ HTML report generated: results/report-{scan_id}.html")
          PYEOF

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-report-${{ github.event.inputs.scan_id }}
          path: results/
          retention-days: 90

      - name: Post to Firebase
        if: always()
        run: |
          curl -X POST "${{ secrets.FIREBASE_FUNCTION_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "scan_type": "vulnerability_report",
              "scan_id": "${{ github.event.inputs.scan_id }}",
              "client_id": "${{ github.event.inputs.client_id }}",
              "total": ${{ steps.parse.outputs.total || 0 }},
              "critical": ${{ steps.parse.outputs.critical || 0 }},
              "high": ${{ steps.parse.outputs.high || 0 }},
              "medium": ${{ steps.parse.outputs.medium || 0 }},
              "low": ${{ steps.parse.outputs.low || 0 }},
              "info": ${{ steps.parse.outputs.info || 0 }},
              "status": "completed",
              "timestamp": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"
            }' || echo "‚ö†Ô∏è Firebase post failed (function may not be deployed)"

      - name: Report Complete
        run: |
          echo "================================================"
          echo "üõ°Ô∏è THREAT INSPECTOR - VULNERABILITY REPORT COMPLETE"
          echo "================================================"
          echo "Client: ${{ steps.config.outputs.client_name }}"
          echo "Total: ${{ steps.parse.outputs.total }}"
          echo "Critical: ${{ steps.parse.outputs.critical }}"
          echo "High: ${{ steps.parse.outputs.high }}"
          echo "Medium: ${{ steps.parse.outputs.medium }}"
          echo "Low: ${{ steps.parse.outputs.low }}"
          echo "Info: ${{ steps.parse.outputs.info }}"
          echo "Scan ID: ${{ github.event.inputs.scan_id }}"
          echo "================================================"
